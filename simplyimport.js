// Generated by CoffeeScript 1.10.0
(function() {
  var applyReplace, args, checkIfInputExists, extRegEx, extend, fs, getFileContents, getNormalizedDirname, help, importHistory, importRegEx, input, notRecursive, output, outputIsFile, path, shouldStdout, shouldUglify, startReplacement, uglify;

  applyIncludesPolyfill();

  args = require('yargs').argv;

  fs = require('fs');

  path = require('path');

  uglify = require('uglify-js');

  extend = require('object-extend');

  extRegEx = /.+\.(js|coffee)$/i;

  importRegEx = /(?:\/\/|\#)\s*?@import\s+(.+)/ig;

  importHistory = [];

  input = args.i || args.input || args._[0];

  output = args.o || args.output || args._[1];

  help = args.h || args.help;

  shouldUglify = args.u || args.uglify;

  shouldStdout = args.s || args.stdout;

  notRecursive = args.n || args.notrecursive;

  outputIsFile = extRegEx.test(output);

  if (help) {
    process.stdout.write("Usage: simplyimport -i <input> -o <output> -[u|s|n]\n \n -i, --input   <path>        Path of the file to compile. Can be relative or absolute.\n -o, --output  <path>        Path to write the compiled file to. Can be a file, or directory. If omitted the compiled result will be written to stdout.\n -s, --stdout                Output the compiled result to stdout. (Occurs by default if no output argument supplied.)\n -u, --uglify                Uglify/minify the compiled file.\n -n, --notrecursive          Don't attend/follow @import directives inside imported files.\n -h, --help                  Print usage info.\n");
    process.exit(0);
  }

  startReplacement = function(input, output, passedOptions) {
    var defaultOptions, dirContext, fileExt, inputContent, inputIsFromModule, isCoffeeFile, options, replacedContent;
    defaultOptions = {
      inputType: 'stream',
      outputIsFile: false,
      uglify: false,
      recursive: true,
      stdout: false
    };
    options = extend(defaultOptions, passedOptions);
    if ((output == null) && !options.stdout) {
      inputIsFromModule = true;
    }
    if (options.inputType === 'stream') {
      inputContent = input;
      dirContext = process.cwd();
    } else if (options.inputType === 'path') {
      input = path.normalize(input);
      output = path.normalize(output);
      fileExt = input.match(extRegEx)[1];
      isCoffeeFile = fileExt.toLowerCase() === 'coffee';
      inputContent = getFileContents(input, isCoffeeFile, inputIsFromModule);
      dirContext = getNormalizedDirname(input);
    }
    replacedContent = applyReplace(inputContent, dirContext, isCoffeeFile);
    if (shouldUglify) {
      replacedContent = uglify.minify(replacedContent, {
        fromString: true
      }).code;
    }
    if (inputIsFromModule) {
      return replacedContent;
    } else {
      if (options.outputIsFile) {
        return fs.writeFileSync(output, replacedContent);
      } else {
        return process.stdout.write(replacedContent);
      }
    }
  };

  applyReplace = function(input, dirContext, isCoffeeFile) {
    return output = input.replace(importRegEx, function(match, filePath) {
      var childDirContext, childIsCoffeeFile, importedFileContent, importedHasImports, replacedContent, resolvedPath;
      filePath = filePath.replace(/['"]/g, '');
      resolvedPath = path.normalize(dirContext + '/' + filePath);
      childIsCoffeeFile = (resolvedPath.match(extRegEx) != null) && resolvedPath.match(extRegEx)[1].toLowerCase() === 'coffee';
      importedFileContent = getFileContents(resolvedPath, isCoffeeFile);
      importedHasImports = importRegEx.test(importedFileContent);
      replacedContent = match;
      if (!importedFileContent) {
        return match;
      }
      if (!importHistory.includes(resolvedPath)) {
        importHistory.push(resolvedPath);
        if (importedHasImports) {
          childDirContext = getNormalizedDirname(resolvedPath);
          replacedContent = applyReplace(importedFileContent, childDirContext, childIsCoffeeFile);
        } else {
          replacedContent = importedFileContent;
        }
      }
      if (isCoffeeFile && !childIsCoffeeFile) {
        return '`' + replacedContent + '`';
      } else if (!isCoffeeFile && childIsCoffeeFile) {
        throw new Error('You\'re trying to import a coffeescript file into a JS file, I don\'t think that\'ll work out well :)');
        return process.exit(1);
      } else {
        return replacedContent;
      }
    });
  };

  getFileContents = function(inputPath, isCoffeeFile, inputIsFromModule) {
    var extension, inputPathHasExt;
    if (inputIsFromModule) {
      return inputIsFromModule;
    } else {
      extension = isCoffeeFile ? '.coffee' : '.js';
      inputPathHasExt = extRegEx.test(inputPath);
      if (!inputPathHasExt) {
        inputPath = inputPath + extension;
      }
      if (checkIfInputExists(inputPath)) {
        return fs.readFileSync(inputPath).toString();
      } else {
        return false;
      }
    }
  };

  getNormalizedDirname = function(inputPath) {
    return path.normalize(path.dirname(path.resolve(inputPath)));
  };

  checkIfInputExists = function(inputPath) {
    var error, error1;
    try {
      if (fs.statSync(inputPath).isFile()) {
        return true;
      } else {
        return false;
      }
    } catch (error1) {
      error = error1;
      return false;
    }
  };


  /*==========================================================================
     Calling and Initing the script
     ==========================================================================
   */

  if (!output && (input != null)) {
    output = input.replace(extRegEx, function(entire, endOfPath) {
      return '.compiled.' + endOfPath;
    });
  } else if (!outputIsFile) {
    if (output.charAt(output.length - 1) !== '/') {
      output = output + '/';
    }
    output = output + input.replace(extRegEx, function(entire, endOfPath) {
      return '.compiled.' + endOfPath;
    });
  }

  if (input != null) {
    startReplacement(input, output, {
      inputType: 'path',
      uglify: shouldUglify,
      shouldStdout: shouldStdout,
      recursive: !notRecursive,
      outputIsFile: outputIsFile
    });
  } else {
    input = '';
    process.stdin.on('data', function(data) {
      return input += data.toString();
    });
    process.stdin.on('end', function() {
      return startReplacement(input, output, {
        inputType: 'stream',
        uglify: shouldUglify,
        shouldStdout: shouldStdout,
        recursive: !notRecursive
      });
    });
  }

  function applyIncludesPolyfill(){
	if (!Array.prototype.includes) {
		Array.prototype.includes = function(searchElement /*, fromIndex*/ ) {
			'use strict';
			var O = Object(this),
				len = parseInt(O.length) || 0;
			if (len === 0) return false;
			
			var n = parseInt(arguments[1]) || 0,
				k;
			if (n >= 0) {
			  k = n;
			} else {
			  k = len + n;
			  if (k < 0) {k = 0;}
			}
			var currentElement;
			while (k < len) {
			  currentElement = O[k];
			  if (searchElement === currentElement ||
			     (searchElement !== searchElement && currentElement !== currentElement)) {
			    return true;
			  }
			  k++;
			}
			return false;
		};
	}
};

  module.exports = startReplacement;

}).call(this);
